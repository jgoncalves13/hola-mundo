<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Criação de Utilizadores Qlik Sense Cloud</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    label, input, button, select { display: block; margin: 10px 0; font-size: 16px; }
    #result { margin-top: 20px; white-space: pre-wrap; color: green; }
  </style>
</head>
<body>

  <h1>Criação de Utilizadores Qlik Sense Cloud</h1>
  <label>Email:</label>
  <input type="email" id="emailInput" placeholder="usuario@dominio.com">

  <label>Selecciona grupo:</label>
  <select id="groupSelect"></select>

  <button onclick="criarUtilizador()">Crear usuario + Asignar grupo</button>
  <div id="result"></div>

  <script>
    const tenant = "keyruspt.eu.qlikcloud.com";
    const clientId = "f6706182174fc70842b6161db71246ba";
    const clientSecret = "0cb9d1b9c63450eecd4143ffa161f53154ed8eafc07d9658c0e261d7775688a9";
    //const clientId = "6099c3a096def460e71f581c6465d572";
    //const clientSecret = "75bca66aa5e957df5bb624cea7d7d609a85e7b6e4bbddc45a4b41ebce0f9eed9";
    let apiToken = "";

    async function getToken() {
      const resp = await fetch(`https://${tenant}/oauth/token`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_id: clientId,
          client_secret: clientSecret,
          grant_type: "client_credentials",
          scope: "user_default admin.users"
        })
      });
      const data = await resp.json();
      apiToken = data.access_token;
      return apiToken;
    }

    async function loadGroups() {
      await getToken();
      const resp = await fetch(`https://${tenant}/api/v1/groups`, {
        headers: { "Authorization": `Bearer ${apiToken}` }
      });
      const data = await resp.json();
      const sel = document.getElementById("groupSelect");
      sel.innerHTML = "";
      data.data.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g.id;
        opt.text = g.name;
        sel.add(opt);
      });
    }

    async function criarUtilizador() {
      const email = document.getElementById("emailInput").value.trim();
      const groupId = document.getElementById("groupSelect").value;
      const resDiv = document.getElementById("result");

      if (!email) return resDiv.innerText = "Introduce un email.";

      await getToken();

      resDiv.innerText = "Creando usuario...";
      const create = await fetch(`https://${tenant}/api/v1/users`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiToken}`
        },
        body: JSON.stringify({
          name: email.split("@")[0],
          //email: "ivida." + email,
          email: "ext." + email,          
          status: "active",
          subject: email.split("@")[1] + "/ivida." + email.split("@")[0],
          assignedRoles: [{ name: "EmbeddedAnalyticsUser" }]
        })
      });

      const user = await create.json();
      if (!create.ok) return resDiv.innerText = "Error: " + JSON.stringify(user, null,2);

      resDiv.innerText = "Usuario creado. Asignando grupo...";

      const upd = await fetch(`https://${tenant}/api/v1/users/${user.id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiToken}`
        },
        body: JSON.stringify([
          {
            op: "replace",
            path: "/assignedGroups",
            value: [{ id: groupId }]
          }
        ])
      });

      if (upd.ok) {
        resDiv.innerText = "Usuario asignado al grupo correctamente.";
      } else {
        const err = await upd.json();
        resDiv.innerText = "Error al asignar grupo: " + JSON.stringify(err, null,2);
      }
    }

    window.onload = loadGroups;
  </script>

</body>
</html>
