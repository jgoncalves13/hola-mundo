<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Embed Qlik App using OAuth M2M</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    iframe { width: 100%; height: 600px; border: none; margin-top: 20px; }
    #result { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Embed Qlik App con OAuth M2M</h1>
  <button onclick="connectAndEmbed()">Conectar e Embutir Aplicação</button>
  <div id="result"></div>
  <iframe id="qlikApp" style="display: none;"></iframe>

  <script>
    async function getAccessToken() {
      const options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
        },
        body: JSON.stringify({
          client_id: "f6706182174fc70842b6161db71246ba",
          client_secret: "0cb9d1b9c63450eecd4143ffa161f53154ed8eafc07d9658c0e261d7775688a9",
          grant_type: "urn:qlik:oauth:user-impersonation",
          user_lookup: {
                 field: "userId", // puede ser 'email', 'subject', 'userId'
                 value: "Juan Gonçalves" // ← usuario del tenant Qlik
                       },
          scope: "user_default"
          //grant_type: "client_credentials",
          //impersonated_user: "Juan Gonçalves",
          //scope: "user_default admin_classic impersonate"
        })
      };

      const response = await fetch("https://keyruspt.eu.qlikcloud.com/oauth/token", options);

      if (response.ok) {
        const tokenInfo = await response.json();
        return tokenInfo.access_token;
      } else {
        console.error("Erro ao obter token");
        return null;
      }
    }

    async function connectAndEmbed() {
      const accessToken = await getAccessToken();

      if (!accessToken) {
        document.getElementById("result").innerText = "Não foi possível obter o token";
        return;
      }

      document.getElementById("result").innerText = "Token obtido. Incorporando a aplicação...";

      // Ajusta estos valores con tu app y hoja reales
      const appId = "2600467e-7e6c-4c36-9fb4-2139caa1cb4d";
      const sheetId = "pwn"; // Opcional
      const tenant = "keyruspt.eu.qlikcloud.com";

      const iframeUrl = `https://${tenant}/single/?appid=${appId}&sheet=${sheetId}&opt=ctxmenu,currsel&theme=classic`;

      const iframe = document.getElementById("qlikApp");
      iframe.src = iframeUrl;
      iframe.style.display = "block";
    }
  </script>
</body>
</html>
