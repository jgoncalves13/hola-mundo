<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qlik Cloud OAuth - Impersonation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Obtener Access Token usando OAuth Impersonation</h1>
  <button onclick="start()">Obtener Token</button>
  <div id="result"></div>

  <script>
    const hostConfig = {
      host: "https://keyruspt.eu.qlikcloud.com", // ← REEMPLAZA con tu tenant real
    };

    const payload = {
      client_id: "6099c3a096def460e71f581c6465d572", // ← REEMPLAZA con tu client_id
      client_secret: "144b9dc2c363da25e0bc1e810b0634b6ddf99a3dbc208c74d711e5a7e9ca38db", // ← REEMPLAZA
      grant_type: "urn:qlik:oauth:user-impersonation",
      user_lookup: {
        field: "subject", // puede ser 'email', 'subject', 'userId'
        value: "juan.goncalves@keyrus.com" // ← usuario del tenant Qlik
      },
      scope: "user_default"
    };

    async function getAccessToken(hostConfig, payload) {
      const res = await fetch(`${hostConfig.host}/oauth/token`, {
        method: "POST",
        mode: "cors",
        credentials: "omit", // debe ser omit, porque este flujo no usa cookies
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      return data;
    }

    async function start() {
      document.getElementById("result").innerText = "Solicitando token...";
      try {
        const tokenInfo = await getAccessToken(hostConfig, payload);
        document.getElementById("result").innerHTML = `<h3>Access Token:</h3><pre>${JSON.stringify(tokenInfo, null, 2)}</pre>`;
      } catch (err) {
        document.getElementById("result").innerText = "Error al obtener token:\n" + err;
      }
    }
  </script>
</body>
</html>
